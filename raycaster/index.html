<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>raycast demo</title>

   <style>
      html, body{
         margin: 0;
         width: 100%;
         height: 100%;
         overflow: hidden;
      }
   </style>
</head>
<body>
   <canvas id="canvas"></canvas>

   <script>
      //const PI = 3.1415926535
      const TARGET_FPS = 60;
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const DR = 0.0174533;
      OnWindowResized();

      var map = [
         1, 1, 1, 1, 1, 1, 1, 1,
         1, 0, 0, 1, 0, 0, 1, 1,
         1, 0, 0, 0, 0, 0, 0, 1,
         1, 0, 0, 1, 0, 0, 0, 1,
         1, 0, 0, 1, 0, 0, 0, 1,
         1, 1, 1, 1, 1, 0, 1, 1,
         1, 0, 0, 0, 0, 0, 0, 1,
         1, 1, 1, 1, 1, 1, 1, 1
      ];

      var keys = {};

      var player = {
         x: canvas.width/2,
         y: canvas.height/2,
         dx: 0,
         dy: 0,
         angle: 0,
         speed: 3,
         width: 10
      }

      function init() {
         SetPlayerDeltas();

         setInterval(render, 1000/TARGET_FPS);
      }

      function render() {
         ctx.clearRect(0, 0, canvas.width, canvas.height);

         drawRays3D();
         

         ctx.fillStyle = "#ff00ff";
         ctx.fillRect(player.x,  player.y, player.width, player.width);
         ctx.beginPath();
         ctx.moveTo(player.x + player.width/2, player.y + player.width/2);
         ctx.lineTo(player.x + player.dx * 15, player.y + player.dy * 15);
         ctx.stroke();


         for(var x = 0; x < 8; x++) {
            for(var y = 0; y < 8; y++) {
               if(map[x  + y * 8] == 1) {
                  ctx.fillStyle = "#121212";
                  ctx.fillRect(x * 64, y * 64, 62, 62);
               }
            }
         }

         if(keys['38'] || keys[87]) {          // up
            player.x += player.dx;
            player.y += player.dy;
         } else if(keys[40] || keys[83]) {   // down
            player.x -= player.dx;
            player.y -= player.dy;
         }

         if (keys[37] || keys[65]) {         // left
            player.angle -=  0.1;
            if(player.angle < 0) {
               player.angle += 2 * Math.PI;
            }
            
            SetPlayerDeltas();
         } else if(keys[39] || keys[68]) {   // right
            player.angle +=  0.1;
            if(player.angle > 2 * Math.PI) {
               player.angle -= 2 * Math.PI;
            }

            SetPlayerDeltas();
         }
      }

      function SetPlayerDeltas() {
         player.dx = Math.cos(player.angle) * player.speed;
         player.dy = Math.sin(player.angle) * player.speed;
      }

      function dist(ax, ay, bx, by, ang) {
         return (Math.sqrt((bx-ax)*(bx-ax) + (by-ay)*(by-ay)));
      }

      function drawRays3D() {
         var r,mx,my,mp,dof;
         var rx=0.0,ry=0.0,ra=0.0,xo=0.0,yo=0.0,disT=0.0;
         ra=player.angle-DR*30;
         if(ra<0) {
            ra += 2 * Math.PI;
         }
         if(ra > 2 * Math.PI) {
            ra -= 2 * Math.PI;
         }
         for(r = 0; r < 60; r++) {
            dof = 0;
            var disH=1000000,hx=player.x,hy=player.y;
            var aTan = -1/Math.tan(ra);
            if(ra>Math.PI) {
               ry=((player.y>>6)<<6)-0.0001;
               rx = (player.y-ry) * aTan+player.x;
               yo=-64;
               xo=-yo*aTan;
            }
            if(ra<Math.PI) {
               ry=((player.y>>6)<<6)+64;
               rx = (player.y-ry) * aTan+player.x;
               yo=64;
               xo=-yo*aTan;
            }
            if(ra==0 || ra==Math.PI) {
               rx=player.x;
               ry=player.sy;
               dof = 8;
            }
            while(dof < 8) {
               mx = rx >> 6;
               my = ry >> 6;
               mp=my*8+mx;
               if(mp > 0 && mp<8*8 && map[mp]==1) {
                  hx=rx;
                  hy=ry;
                  disH=dist(player.x,player.y,hx,hy,ra);
                  dof = 8;
               } else {
                  rx+=xo;
                  ry+=yo;
                  dof+=1;
               }
            }

            dof = 0;
            var disV=1000000,vx=player.x,vy=player.y;
            var nTan = -Math.tan(ra);
            if(ra>Math.PI / 2 && ra<3*Math.PI/2) {
               rx=((player.x>>6)<<6)-0.0001;
               ry = (player.x-rx) * nTan+player.y;
               xo=-64;
               yo=-xo*nTan;
            }
            if(ra < Math.PI / 2 || ra > 3*Math.PI/2) {
               rx=((player.x>>6)<<6)+64;
               ry = (player.x-rx) * nTan+player.y;
               xo=64;
               yo=-xo*nTan;
            }
            if(ra==0 || ra==Math.PI) {
               rx=player.x;
               ry=player.sy;
               dof = 8;
            }
            while(dof < 8) {
               mx = rx >> 6;
               my = ry >> 6;
               mp=my*8+mx;
               if(mp > 0 && mp<8*8 && map[mp]==1) {
                  vx=rx;
                  vy=ry;
                  disV=dist(player.x,player.y,vx,vy,ra);
                  dof = 8;
               } else {
                  rx+=xo;
                  ry+=yo;
                  dof+=1;
               }
            }

            if(disV<disH) {
               rx=vx;
               ry=vy;
               disT=disV;
               ctx.fillStyle = "#c9be9f"
            } 
            if(disH<disV) {
               rx=hx;
               ry=hy;
               disT=disH;
               ctx.fillStyle = "#ada489"
            }
            ctx.strokeStyle = "#7f007f"
            ctx.beginPath();
            ctx.moveTo(player.x + player.width/2, player.y + player.width/2);
            ctx.lineTo(rx, ry);
            ctx.stroke();

            //3d walls
            var ca=player.angle-ra;
            if(ca<0) {
               ca += 2 * Math.PI;
            }
            if(ca > 2 * Math.PI) {
               ca -= 2 * Math.PI;
            }
            disT = disT*Math.cos(ca);
            var lineH = (64 * 320)/disT;
            if(lineH > 320) lineH = 320;
            var lineO = 160-(lineH>>1);
            
            ctx.fillRect(r*8+530,lineO,+8,lineH)

            ra+=DR;
            if(ra<0) {
               ra += 2 * Math.PI;
            }
            if(ra > 2 * Math.PI) {
               ra -= 2 * Math.PI;
            }

         }
      }
            
      // updates the canvas dimensions appropriately
      function OnWindowResized() {
         canvas.width = window.innerWidth;
         canvas.height = window.innerHeight;
      }

      // capture player movement via input
      document.onkeyup = function(e) { keys[e.keyCode] = false; }
      document.onkeydown = function(e) { keys[e.keyCode] = true; }

      // runs when the window is resized, updates dimensions
      document.addEventListener('resize', function() {
         OnWindowResized();
      })

      init();
        
   </script>
</body>
</html>